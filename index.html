<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STVOR SDK ‚Äî Documentation</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --bg-main: #ffffff;
      --bg-secondary: #f8fafc;
      --border: #e2e8f0;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --success: #059669;
      --danger: #dc2626;
      --warning: #f59e0b;
      --sidebar-width: clamp(200px, 20vw, 280px);
      --font-size-base: clamp(13px, 2vw, 16px);
      --font-size-h1: clamp(24px, 6vw, 48px);
      --font-size-h2: clamp(20px, 4vw, 28px);
      --font-size-h3: clamp(16px, 3vw, 18px);
      --padding-mobile: clamp(12px, 3vw, 24px);
      --padding-content: clamp(16px, 4vw, 32px);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: clamp(1.5, 0.5vw + 1.5, 1.8);
      color: var(--text-primary);
      background: var(--bg-secondary);
      margin: 0;
      font-size: var(--font-size-base);
    }
    
    .layout { display: flex; min-height: 100vh; }
    
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-main);
      border-right: 1px solid var(--border);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      padding: 24px 0;
    }
    .sidebar-header {
      padding: 0 24px 24px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }
    .logo {
      font-size: clamp(20px, 5vw, 24px);
      font-weight: 800;
      color: var(--text-primary);
      text-decoration: none;
      display: block;
      margin-bottom: 4px;
    }
    .logo-tagline {
      font-size: clamp(10px, 1.5vw, 12px);
      color: var(--text-muted);
      font-weight: 500;
    }
    .nav-section { margin-bottom: clamp(16px, 2vw, 24px); }
    .nav-title {
      font-size: clamp(9px, 1.2vw, 11px);
      font-weight: 700;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 0 clamp(12px, 2vw, 24px) clamp(4px, 1vw, 8px);
      letter-spacing: 0.5px;
    }
    .nav-item {
      display: block;
      padding: clamp(6px, 1.5vw, 8px) clamp(12px, 2vw, 24px);
      color: var(--text-secondary);
      text-decoration: none;
      font-size: clamp(12px, 1.8vw, 14px);
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }
    .nav-item:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }
    .nav-item.active {
      color: var(--primary);
      border-left-color: var(--primary);
      background: #eff6ff;
    }
    
    .main-content {
      margin-left: var(--sidebar-width);
      flex: 1;
    }
    .topbar {
      background: var(--bg-main);
      border-bottom: 1px solid var(--border);
      padding: clamp(8px, 2vw, 12px) clamp(16px, 3vw, 32px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .tabs { display: flex; gap: clamp(12px, 3vw, 24px); }
    .tab {
      padding: clamp(4px, 1.2vw, 8px) 0;
      font-size: clamp(12px, 1.8vw, 14px);
      color: var(--text-muted);
      text-decoration: none;
      border-bottom: 2px solid transparent;
    }
    .tab:hover { color: var(--text-primary); }
    .tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    
    .content { max-width: 900px; padding: clamp(24px, 5vw, 48px) var(--padding-content); }
    
    header { margin-bottom: clamp(24px, 4vw, 40px); }
    header h1 { font-size: var(--font-size-h1); font-weight: 800; margin-bottom: clamp(8px, 2vw, 12px); }
    .tagline { font-size: clamp(16px, 3vw, 20px); color: var(--text-secondary); }
    
    .intro-card {
      background: linear-gradient(135deg, #eff6ff 0%, #f8fafc 100%);
      border: 1px solid #bfdbfe;
      border-radius: clamp(8px, 2vw, 12px);
      padding: clamp(16px, 3vw, 24px);
      margin-bottom: clamp(24px, 4vw, 40px);
    }
    
    h2 {
      font-size: var(--font-size-h2);
      font-weight: 700;
      margin: clamp(32px, 5vw, 48px) 0 clamp(10px, 2vw, 16px) 0;
      padding-top: clamp(12px, 2vw, 16px);
      border-top: 1px solid var(--border);
    }
    h2:first-of-type { border-top: none; margin-top: 0; }
    h3 { font-size: var(--font-size-h3); margin: clamp(16px, 2.5vw, 24px) 0 clamp(8px, 1.5vw, 12px) 0; }
    p { margin: 0 0 clamp(10px, 2vw, 16px) 0; color: var(--text-secondary); }
    
    .card {
      background: white;
      border: 1px solid var(--border);
      border-radius: clamp(6px, 1.5vw, 8px);
      padding: clamp(16px, 3vw, 24px);
      margin: clamp(12px, 2vw, 16px) 0;
    }
    
    ul { margin: 0 0 clamp(12px, 2vw, 20px) 0; padding-left: clamp(16px, 3vw, 24px); color: #475569; }
    li { margin-bottom: clamp(4px, 1vw, 8px); }
    
    .code-block {
      position: relative;
      margin: clamp(12px, 2vw, 16px) 0;
    }
    .copy-btn {
      position: absolute;
      top: clamp(8px, 2vw, 12px);
      right: clamp(8px, 2vw, 12px);
      background: #334155;
      color: #e2e8f0;
      border: none;
      padding: clamp(4px, 1vw, 6px) clamp(8px, 1.5vw, 12px);
      border-radius: 4px;
      cursor: pointer;
      font-size: clamp(10px, 1.5vw, 12px);
      opacity: 0.8;
      transition: all 0.2s;
    }
    .copy-btn:hover { opacity: 1; background: #475569; }
    .copy-btn.copied { background: var(--success); }
    
    pre {
      background: #0f172a;
      color: #e2e8f0;
      padding: clamp(12px, 2.5vw, 20px);
      border-radius: 8px;
      overflow-x: auto;
      font-size: clamp(11px, 1.8vw, 14px);
      line-height: clamp(1.4, 0.5vw + 1.4, 1.8);
      margin: 0;
    }
    code { font-family: 'SF Mono', Monaco, 'Courier New', monospace; }
    
    .btn {
      display: inline-block;
      padding: clamp(10px, 2vw, 12px) clamp(16px, 3vw, 24px);
      font-size: clamp(12px, 1.8vw, 14px);
      font-weight: 600;
      border: none;
      border-radius: clamp(4px, 1vw, 6px);
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }
    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #e2e8f0; color: #334155; margin-left: 8px; }
    .btn-secondary:hover { background: #cbd5e1; }
    
    .warning {
      background: #fef3c7;
      border-left: 4px solid #f59e0b;
      padding: clamp(10px, 2vw, 12px) clamp(12px, 2.5vw, 16px);
      border-radius: 0 6px 6px 0;
      margin: clamp(12px, 2vw, 16px) 0;
      font-size: clamp(12px, 1.8vw, 14px);
      color: #92400e;
    }
    .success-box {
      background: #ecfdf5;
      border: 1px solid #a7f3d0;
      border-radius: 8px;
      padding: clamp(16px, 3vw, 24px);
      margin: clamp(12px, 2vw, 16px) 0;
    }
    
    .step {
      display: flex;
      gap: clamp(12px, 2vw, 16px);
      margin: clamp(16px, 2.5vw, 24px) 0;
      padding: clamp(12px, 2.5vw, 20px);
      background: white;
      border: 1px solid var(--border);
      border-radius: clamp(6px, 1.5vw, 8px);
    }
    .step-number {
      width: clamp(28px, 4vw, 32px);
      height: clamp(28px, 4vw, 32px);
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
      font-size: clamp(14px, 2vw, 16px);
    }
    .step-content { flex: 1; }
    .step-content h4 { margin: 0 0 clamp(6px, 1vw, 8px) 0; }
    
    footer {
      margin-top: clamp(32px, 5vw, 64px);
      padding-top: clamp(12px, 2vw, 24px);
      border-top: 1px solid #e2e8f0;
      text-align: center;
      color: #94a3b8;
      font-size: clamp(11px, 1.5vw, 14px);
    }

    /* ===== RESPONSIVE DESIGN ===== */
    
    /* Tablets and below 1024px */
    @media (max-width: 1024px) {
      :root { --sidebar-width: 240px; }
      .content { padding: 32px 24px; }
      header h1 { font-size: 36px; }
      h2 { font-size: 24px; }
      .intro-card { padding: 16px; }
      .intro-card > div { grid-template-columns: 1fr; }
      pre { font-size: 12px; }
    }

    /* Small tablets 768px and below */
    @media (max-width: 768px) {
      :root { --sidebar-width: 0; }
      
      .layout { flex-direction: column; }
      
      .sidebar {
        position: fixed;
        left: -280px;
        top: 0;
        width: 280px;
        height: 100vh;
        z-index: 1000;
        transition: left 0.3s ease;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }
      
      .sidebar.open { left: 0; }
      
      .main-content {
        margin-left: 0;
        width: 100%;
      }
      
      .topbar {
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .tabs { gap: 16px; font-size: 13px; }
      .tab { padding: 6px 0; }
      
      .content { padding: 24px 16px; }
      
      header h1 {
        font-size: 28px;
        margin-bottom: 8px;
      }
      
      .tagline { font-size: 16px; }
      
      h2 {
        font-size: 20px;
        margin: 32px 0 12px 0;
        padding-top: 12px;
      }
      
      h3 { font-size: 16px; margin: 16px 0 8px 0; }
      
      .intro-card { padding: 12px; margin-bottom: 24px; }
      .intro-card > div { 
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .step {
        flex-direction: column;
        padding: 16px;
        gap: 12px;
      }
      
      .step-number { 
        width: 28px;
        height: 28px;
        font-size: 14px;
      }
      
      .code-block { margin: 12px 0; }
      pre { 
        padding: 12px;
        font-size: 11px;
        overflow-x: auto;
      }
      
      .copy-btn {
        padding: 4px 8px;
        font-size: 11px;
        top: 8px;
        right: 8px;
      }
      
      .btn {
        padding: 10px 16px;
        font-size: 13px;
      }
      
      .btn-primary { padding: 8px 12px; font-size: 13px; }
      .btn-secondary { margin-left: 0; margin-top: 8px; }
      
      .warning { font-size: 13px; padding: 10px 12px; }
      
      .success-box { padding: 16px; margin: 12px 0; }
      
      .intro-card > div { grid-template-columns: 1fr; }
      
      footer { margin-top: 32px; font-size: 12px; }
    }

    /* Mobile phones 480px and below */
    @media (max-width: 480px) {
      :root {
        --sidebar-width: 0;
        --text-primary: #0f172a;
      }
      
      body { font-size: 14px; }
      
      .main-content { width: 100%; }
      
      .topbar {
        flex-wrap: wrap;
        gap: 12px;
        padding: 12px 12px;
      }
      
      .tabs {
        gap: 8px;
        width: 100%;
      }
      
      .tab { font-size: 12px; padding: 4px 0; }
      
      .content { 
        padding: 16px 12px;
        max-width: 100%;
      }
      
      header h1 {
        font-size: 24px;
        margin-bottom: 6px;
      }
      
      .tagline { 
        font-size: 14px;
        line-height: 1.4;
      }
      
      h2 {
        font-size: 18px;
        margin: 24px 0 10px 0;
        padding-top: 12px;
      }
      
      h3 { 
        font-size: 15px;
        margin: 12px 0 6px 0;
      }
      
      p { 
        margin-bottom: 12px;
        font-size: 13px;
        line-height: 1.5;
      }
      
      ul { margin: 0 0 12px 16px; font-size: 13px; }
      li { margin-bottom: 4px; }
      
      .intro-card {
        padding: 12px;
        margin-bottom: 16px;
        border-radius: 6px;
      }
      
      .intro-card > div { 
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .intro-card ul { margin: 4px 0 0 16px; padding: 0; }
      
      .card {
        padding: 16px;
        margin: 12px 0;
        border-radius: 6px;
      }
      
      .step {
        flex-direction: column;
        padding: 12px;
        gap: 8px;
        margin: 12px 0;
      }
      
      .step-number {
        width: 24px;
        height: 24px;
        font-size: 12px;
        flex-shrink: 0;
      }
      
      .code-block { 
        margin: 8px 0;
        position: relative;
      }
      
      pre {
        padding: 10px;
        font-size: 10px;
        line-height: 1.4;
        overflow-x: auto;
      }
      
      code { font-size: 10px; }
      
      .copy-btn {
        padding: 4px 6px;
        font-size: 10px;
        top: 6px;
        right: 6px;
      }
      
      .btn {
        padding: 10px 12px;
        font-size: 12px;
        border-radius: 4px;
        width: 100%;
        text-align: center;
      }
      
      .btn-secondary { 
        margin-left: 0;
        margin-top: 6px;
        width: 100%;
      }
      
      .warning {
        font-size: 12px;
        padding: 10px 12px;
        border-left-width: 3px;
        margin: 12px 0;
      }
      
      .success-box {
        padding: 12px;
        margin: 12px 0;
        border-radius: 6px;
      }
      
      .success-box h4 { font-size: 13px; }
      .success-box pre { 
        font-size: 9px;
        padding: 8px;
        margin: 8px 0 0 0;
      }
      
      footer {
        margin-top: 24px;
        padding-top: 12px;
        font-size: 11px;
      }
    }

    /* Extra small phones 360px and below */
    @media (max-width: 360px) {
      header h1 {
        font-size: 20px;
        margin-bottom: 4px;
      }
      
      .tagline { font-size: 12px; }
      
      h2 { font-size: 16px; }
      h3 { font-size: 14px; }
      
      .content { padding: 12px 10px; }
      
      pre { font-size: 9px; }
      code { font-size: 9px; }
      
      .btn { padding: 8px 10px; font-size: 11px; }
    }
  </style>
</head>
<body>
  <div class="layout">
    
    <!-- SIDEBAR -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <a href="#" class="logo">STVOR</a>
        <div class="logo-tagline">E2EE SDK v3.0</div>
      </div>
      
      <div class="nav-section">
        <div class="nav-title">Getting Started</div>
        <a href="#overview" class="nav-item active">Overview</a>
        <a href="#installation" class="nav-item">Installation</a>
        <a href="#quickstart" class="nav-item">Quick Start</a>
        <a href="#full-example" class="nav-item">Full Example</a>
      </div>
      
      <div class="nav-section">
        <div class="nav-title">v3.0 Production</div>
        <a href="#v3-improvements" class="nav-item">What's New</a>
        <a href="#v3-architecture" class="nav-item">Architecture</a>
        <a href="#v3-security" class="nav-item">Security Invariants</a>
      </div>
      
      <div class="nav-section">
        <div class="nav-title">Core Concepts</div>
        <a href="#security" class="nav-item">Security Model</a>
        <a href="#limitations" class="nav-item">Limitations</a>
      </div>
      
      <div class="nav-section">
        <div class="nav-title">Resources</div>
        <a href="/dashboard.html" class="nav-item">Dashboard</a>
        <a href="https://github.com/izahii/stvor-api" class="nav-item" target="_blank">GitHub ‚Üí</a>
      </div>
    </nav>
    
    <!-- MAIN CONTENT -->
    <div class="main-content">
      
      <!-- TOPBAR -->
      <div class="topbar">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div class="tabs">
            <a href="#overview" class="tab active">Docs</a>
            <a href="#full-example" class="tab">Examples</a>
          </div>
          <a href="/dashboard.html" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
            Open Dashboard ‚Üí
          </a>
        </div>
      </div>
      
      <!-- CONTENT -->
      <div class="content">
        
        <!-- HEADER -->
        <header id="overview">
          <h1>STVOR SDK</h1>
          <p class="tagline">Production-grade E2EE with Signal Protocol ‚Äî minimal API</p>
        </header>

        <div class="intro-card">
          <p><strong>STVOR v3.0</strong> provides battle-tested end-to-end encryption using the Signal Protocol (X3DH + Double Ratchet). Messages are encrypted on the client ‚Äî the server never sees plaintext. Now with production-ready architecture, security invariants, and crypto-verified metrics.</p>
          <div style="margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <strong style="color: var(--success);">‚úÖ v3.0 Features:</strong>
              <ul style="margin: 8px 0 0 20px; padding: 0;">
                <li>AAD header authentication</li>
                <li>Immutable state transitions</li>
                <li>Persistent storage adapters</li>
                <li>Forced DH ratcheting</li>
              </ul>
            </div>
            <div>
              <strong style="color: var(--success);">‚úÖ Production Ready:</strong>
              <ul style="margin: 8px 0 0 20px; padding: 0;">
                <li>6 security invariants</li>
                <li>State machine FSM</li>
                <li>Crypto-verified metrics</li>
                <li>Full test suite</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- INSTALLATION -->
        <h2 id="installation">Installation</h2>
        
        <div class="step">
          <div class="step-number">1</div>
          <div class="step-content">
            <h4>Install the SDK (v3.0)</h4>
            <div class="code-block">
              <button class="copy-btn" onclick="copyCode(this)">Copy</button>
              <pre><code>npm install @stvor/sdk</code></pre>
            </div>
          </div>
        </div>

        <div class="success-box">
          <h4 style="margin: 0 0 8px 0; color: var(--success);">‚ú® New in v3.0</h4>
          <p style="margin: 0;">Production-ready architecture with security invariants. No more <code>ws</code> import needed ‚Äî it's hidden inside the SDK!</p>
        </div>

        <!-- QUICK START -->
        <h2 id="quickstart">Quick Start (v3.0)</h2>
        <p>The simplest example ‚Äî connect two users and send an encrypted message with zero crypto knowledge:</p>
        
        <div class="code-block">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>import { createApp } from '@stvor/sdk';

// Create app with production config
const app = await createApp({
  appToken: 'sk_live_xxx',
  relayUrl: 'wss://relay.stvor.com',
  storageAdapters: {
    replay: redisReplayCache,      // Required for production
    tofu: postgresTofuStore,        // Required for production  
    sessions: postgresSessionStore, // Recommended
    identity: keystoreIdentity      // Recommended
  }
});

// Connect & setup listeners
const alice = await app.connect('alice@example.com');
const bob = await app.connect('bob@example.com');

bob.onMessage((from, msg) => console.log(`üì© ${from}: ${msg}`));

// Send (fully encrypted end-to-end)
await alice.send('bob@example.com', 'Hello! üîê');
console.log('‚úÖ Sent');</code></pre>
        </div>
        
        <h3>Minimal Example (Dev Mode)</h3>
        <p>For development/testing without storage adapters:</p>
        
        <div class="code-block">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>import { createApp } from '@stvor/sdk';

const app = await createApp({
  appToken: 'demo_token',
  relayUrl: 'ws://localhost:8080'
  // Storage adapters optional in dev mode
});

const user = await app.connect('user@test.com');
user.onMessage((from, msg) => console.log(msg));
await user.send('peer@test.com', 'Encrypted message!');</code></pre>
        </div>

        <!-- V3.0 IMPROVEMENTS -->
        <h2 id="v3-improvements">v3.0 Improvements</h2>
        
        <div class="card">
          <h3 style="margin-top: 0;">Security Fixes</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr style="border-bottom: 1px solid #e2e8f0;">
              <td style="padding: 8px; font-weight: 600; color: var(--danger);">‚ùå v2 Issue</td>
              <td style="padding: 8px; font-weight: 600; color: var(--success);">‚úÖ v3 Fix</td>
            </tr>
            <tr style="border-bottom: 1px solid #e2e8f0;">
              <td style="padding: 8px;">Header tampering (AAD=null)</td>
              <td style="padding: 8px;">AAD authentication on all fields</td>
            </tr>
            <tr style="border-bottom: 1px solid #e2e8f0;">
              <td style="padding: 8px;">State corruption on decrypt failure</td>
              <td style="padding: 8px;">Immutable transitions (validate first)</td>
            </tr>
            <tr style="border-bottom: 1px solid #e2e8f0;">
              <td style="padding: 8px;">Replay attacks (memory-only cache)</td>
              <td style="padding: 8px;">Persistent Redis/PostgreSQL cache</td>
            </tr>
            <tr style="border-bottom: 1px solid #e2e8f0;">
              <td style="padding: 8px;">Sessions lost on restart</td>
              <td style="padding: 8px;">Durable session storage</td>
            </tr>
            <tr>
              <td style="padding: 8px;">DH ratchet optional</td>
              <td style="padding: 8px;">Forced ratchet every 50 messages</td>
            </tr>
          </table>
        </div>

        <!-- V3.0 ARCHITECTURE -->
        <h2 id="v3-architecture">Production Architecture</h2>
        
        <h3>Storage Adapters (Required)</h3>
        <p>v3.0 requires pluggable storage for production. SDK will refuse to start if adapters are missing in production mode.</p>
        
        <div class="code-block">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>// Storage Adapter Types (implement these interfaces)

interface IReplayCache {
  // Check if nonce was seen, mark if not
  checkAndMark(peerId: string, nonce: Uint8Array): Promise<boolean>
}

interface ITofuStore {
  // Store & verify fingerprints (immutable)
  storeFingerprint(peerId: string, fingerprint: string): Promise<void>
  verifyFingerprint(peerId: string, fingerprint: string): Promise<boolean>
}

interface ISessionStore {
  // Persist encrypted session state
  save(peerId: string, state: SessionState): Promise<void>
  load(peerId: string): Promise<SessionState | null>
}

interface IIdentityStore {
  // Get or generate identity keypair (immutable)
  getIdentityKeyPair(): Promise<KeyPair>
}</code></pre>
        </div>

        <h3>Example: Redis + PostgreSQL Setup</h3>
        
        <div class="code-block">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>import { createApp } from '@stvor/sdk';
import Redis from 'redis';
import { Pool } from 'pg';

// Redis for replay protection (fast, ephemeral)
const redis = Redis.createClient({ url: 'redis://localhost:6379' });

// PostgreSQL for durable storage
const pg = new Pool({ 
  connectionString: 'postgres://user:pass@localhost/stvor'
});

// Create storage adapters
const replayCache = {
  async checkAndMark(peerId, nonce) {
    const key = `replay:${peerId}:${Buffer.from(nonce).toString('hex')}`;
    const exists = await redis.getex(key, { EX: 300 }); // 5 min TTL
    if (exists) return true; // Replay detected
    await redis.set(key, '1', { EX: 300 });
    return false; // First time seeing this nonce
  }
};

const sessionStore = {
  async save(peerId, state) {
    const encrypted = await encryptState(state); // User's KMS
    await pg.query(
      'INSERT INTO sessions (peer_id, encrypted_state, updated_at) VALUES ($1, $2, NOW()) ON CONFLICT (peer_id) DO UPDATE SET encrypted_state = $2, updated_at = NOW()',
      [peerId, encrypted]
    );
  },
  async load(peerId) {
    const result = await pg.query('SELECT encrypted_state FROM sessions WHERE peer_id = $1', [peerId]);
    if (!result.rows[0]) return null;
    return await decryptState(result.rows[0].encrypted_state);
  }
};

// Create app with adapters
const app = await createApp({
  appToken: 'sk_live_xxx',
  relayUrl: 'wss://relay.stvor.com',
  storageAdapters: {
    replay: replayCache,
    sessions: sessionStore,
    // ... other adapters
  },
  productionMode: true // Hard-fail if adapters missing
});</code></pre>
        </div>

        <!-- V3.0 SECURITY INVARIANTS -->
        <h2 id="v3-security">6 Security Invariants</h2>
        
        <div class="card">
          <p>v3.0 enforces 6 cryptographic invariants that prevent protocol-level attacks:</p>
          
          <h4>I1: State Machine Constraint</h4>
          <p><code>if (state !== ESTABLISHED) ‚Üí cannot send() or receive()</code></p>
          <p style="color: var(--text-muted); font-size: 13px;">Prevents operations on uninitialized or corrupted sessions.</p>
          
          <h4>I2: Key Memory Hygiene</h4>
          <p><code>rootKey never exists in plaintext after initialization</code></p>
          <p style="color: var(--text-muted); font-size: 13px;">Reduces window for key compromise from process memory.</p>
          
          <h4>I3: Atomic State Transitions</h4>
          <p><code>if decrypt() fails ‚Üí session state unchanged</code></p>
          <p style="color: var(--text-muted); font-size: 13px;">Prevents state corruption from decryption errors.</p>
          
          <h4>I4: AAD Authentication</h4>
          <p><code>AAD = HASH(publicKey || nonce || counters || timestamp)</code></p>
          <p style="color: var(--text-muted); font-size: 13px;">Cryptographically binds metadata to ciphertext. Relay cannot tamper with headers.</p>
          
          <h4>I5: Replay Protection</h4>
          <p><code>nonce must be unique within 5-minute TTL window</code></p>
          <p style="color: var(--text-muted); font-size: 13px;">Persistent cache survives process restart.</p>
          
          <h4>I6: Identity Immutability</h4>
          <p><code>Identity keys generated once, never rotate, stored securely</code></p>
          <p style="color: var(--text-muted); font-size: 13px;">Trust anchor cannot be compromised by accident.</p>
        </div>

        <!-- FULL EXAMPLE -->
        <h2 id="full-example">Full Working Example</h2>
        <p>Copy these files to get E2EE working in 2 minutes:</p>

        <h3>Step 1: Create relay-server.mjs</h3>
        
        <div class="warning">
          <strong>‚ö†Ô∏è Demo Transport Only</strong><br>
          This relay server is a minimal example for local development. It is NOT the STVOR API ‚Äî it's a simple WebSocket forwarder to help you test encryption. For production, you'll need proper auth, persistence, and scaling.
        </div>
        
        <p>The relay server forwards encrypted messages between clients. It cannot decrypt anything.</p>
        
        <div class="code-block">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>// relay-server.mjs
import WebSocket, { WebSocketServer } from 'ws';

const PORT = 8080;
const wss = new WebSocketServer({ port: PORT });
console.log(`üîå Relay running on ws://localhost:${PORT}`);

const clients = new Map();
const pubkeys = new Map();

wss.on('connection', (ws) => {
  // Send all known keys to new client
  for (const [user, pub] of pubkeys.entries()) {
    ws.send(JSON.stringify({ type: 'announce', user, pub }));
  }

  ws.on('message', (data) => {
    let msg;
    try { msg = JSON.parse(data.toString()); } catch { return; }

    if (msg.type === 'announce' && msg.user) {
      clients.set(msg.user, ws);
      pubkeys.set(msg.user, msg.pub);
      // Broadcast to all
      for (const [_, client] of clients) {
        if (client.readyState === WebSocket.OPEN) {
          client.send(JSON.stringify({ 
            type: 'announce', 
            user: msg.user, 
            pub: msg.pub 
          }));
        }
      }
    }

    if (msg.type === 'message' && msg.to) {
      const target = clients.get(msg.to);
      if (target && target.readyState === WebSocket.OPEN) {
        target.send(JSON.stringify(msg));
      }
    }
  });
});</code></pre>
        </div>

        <h3>Step 2: Create app.mjs</h3>
        <p>Your application code with E2EE messaging (only STVOR imports needed!):</p>
        
        <div class="code-block">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>// app.mjs
import { createApp } from '@stvor/sdk';

async function main() {
  const app = await createApp({
    appToken: 'stvor_demo_token',
    relayUrl: 'ws://localhost:8080'
  });

  // Connect Bob (receiver)
  const bob = await app.connect('bob@example.com');
  bob.onMessage((from, msg) => {
    console.log(`üì© [Bob] from ${from}: ${msg}`);
  });

  // Connect Alice (sender)
  const alice = await app.connect('alice@example.com');
  alice.onMessage((from, msg) => {
    console.log(`üì© [Alice] from ${from}: ${msg}`);
  });

  // SDK handles all E2EE internally (no WebSocket code needed!)
  await alice.send('bob@example.com', 'Hello Bob! This is E2EE! üîê');
  console.log('‚úÖ Alice sent message');

  // Bob replies
  await bob.send('alice@example.com', 'Hi Alice! Got it! üéâ');
  console.log('‚úÖ Bob sent message');

  // Keep alive to see messages
  await new Promise(r => setTimeout(r, 1000));
}

main().catch(console.error);</code></pre>
        </div>

        <h3>Step 3: Create package.json</h3>
        <div class="code-block">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code>{
  "name": "my-e2ee-app",
  "type": "module",
  "dependencies": {
    "@stvor/sdk": "^2.4.0",
    "ws": "^8.13.0"
  }
}</code></pre>
        </div>

        <h3>Step 4: Run it!</h3>
        <div class="code-block">
          <button class="copy-btn" onclick="copyCode(this)">Copy</button>
          <pre><code># Terminal 1: Start relay
node relay-server.mjs

# Terminal 2: Run app
npm install
node app.mjs</code></pre>
        </div>

        <div class="success-box">
          <h4 style="margin: 0 0 12px 0; color: var(--success);">‚úÖ Expected Output:</h4>
          <pre style="background: #064e3b; margin: 0; padding: 16px;"><code>‚úÖ Alice sent message
‚úÖ Bob sent message
üì© [Bob] from alice@example.com: Hello Bob! This is E2EE! üîê
üì© [Alice] from bob@example.com: Hi Alice! Got it! üéâ</code></pre>
        </div>

        <!-- SECURITY -->
        <h2 id="security">Security Model</h2>
        
        <div class="success-box">
          <h3 style="margin: 0 0 16px 0; color: var(--success);">‚úÖ What STVOR Guarantees</h3>
          <ul style="margin: 0; color: var(--text-primary);">
            <li><strong>End-to-end encryption</strong> ‚Äî plaintext never leaves the device</li>
            <li><strong>Forward Secrecy</strong> ‚Äî compromise of current keys doesn't expose past messages (automatic DH ratchet)</li>
            <li><strong>Post-Compromise Security</strong> ‚Äî after key rotation, attacker loses access (forced ratchet every 50 msgs)</li>
            <li><strong>Zero-knowledge relay</strong> ‚Äî server cannot decrypt messages</li>
            <li><strong>Header Integrity</strong> ‚Äî metadata cannot be tampered with (AAD authentication)</li>
            <li><strong>Replay Protection</strong> ‚Äî each message is unique (persistent nonce cache)</li>
          </ul>
        </div>

        <div class="warning">
          <strong>üîê v3.0: Production-Ready</strong><br>
          This version is suitable for applications requiring production-grade E2EE. Includes security invariants, persistent storage, and crypto-verified metrics. All 6 security guarantees are cryptographically enforced.
        </div>

        <!-- LIMITATIONS -->
        <h2 id="limitations">When to Use (and When Not To)</h2>
        
        <div class="card" style="background: linear-gradient(135deg, #dcfce7 0%, #e0f2fe 100%); border-color: #86efac;">
          <h4 style="margin-top: 0; color: var(--success);">‚úÖ Perfect For (v3.0):</h4>
          <ul style="margin-bottom: 0;">
            <li>Healthcare/Finance applications (production-grade E2EE)</li>
            <li>Internal tools with high security requirements</li>
            <li>IoT & sensor networks</li>
            <li>Enterprise messaging</li>
            <li>Any application requiring NIST-compliant crypto</li>
          </ul>
        </div>

        <div class="card" style="background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%); border-color: #fca5a5;">
          <h4 style="margin-top: 0; color: var(--danger);">‚ùå Not Suitable For (v3.0):</h4>
          <ul style="margin-bottom: 0;">
            <li>Browser/client-side JavaScript (Node.js only)</li>
            <li>Multi-device synchronization (each device = separate identity)</li>
            <li>Applications needing distributed consensus</li>
            <li>Completely offline operation (requires relay server)</li>
          </ul>
        </div>

        <div class="card" style="background: linear-gradient(135deg, #fef9c3 0%, #fef3c7 100%); border-color: #fde047;">
          <h4 style="margin-top: 0;">üìù Architecture Notes</h4>
          <ul style="margin-bottom: 0;">
            <li>Cryptography: libsodium (peer-reviewed, FIPS 140-2 compatible)</li>
            <li>Protocol: Signal Protocol (X3DH + Double Ratchet)</li>
            <li>Transport: WebSocket (your relay handles it)</li>
            <li>State: Configurable storage (Redis, PostgreSQL, Keychain)</li>
            <li>Metrics: HMAC-signed for auditability</li>
          </ul>
        </div>

        <footer>
          <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">STVOR SDK v3.0</div>
          <div>Production-grade E2EE. Signal Protocol-compatible. Zero crypto knowledge required. (Feb 2026)</div>
        </footer>
        
      </div>
    </div>
  </div>

  <script>
    function copyCode(btn) {
      const code = btn.parentElement.querySelector('code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        btn.textContent = '‚úì Copied!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'Copy';
          btn.classList.remove('copied');
        }, 2000);
      });
    }

    document.querySelectorAll('.nav-item, .tab').forEach(link => {
      link.addEventListener('click', function(e) {
        const href = this.getAttribute('href');
        if (href && href.startsWith('#')) {
          e.preventDefault();
          const target = document.querySelector(href);
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }
      });
    });
    
    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('href') === '#' + entry.target.id) {
              item.classList.add('active');
            }
          });
        }
      });
    }, { threshold: 0.3, rootMargin: '-100px 0px -50% 0px' });
    
    document.querySelectorAll('h2[id], header[id]').forEach(section => {
      observer.observe(section);
    });
  </script>
</body>
</html>
